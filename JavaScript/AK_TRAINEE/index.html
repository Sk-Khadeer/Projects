<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Welcome to iCoder. A blog for coding enthusiasts" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <title>AK - Heaven for Programmers</title>
  <style>
    .field-icon {
      float: right;
      margin-right: 20px;
      margin-top: -25px;
      position: relative;
      z-index: 2;
    }

    #loginButton[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .required {
      color: red;
    }
  </style>
</head>

<body>

  <!-- nav bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#"><b>AK</b></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about.html">About</a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Topics
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="#">Technology</a>
            <a class="dropdown-item" href="#">Web Development</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Support</a>
            <a class="dropdown-item" href="#">Write for us</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="contact.html">Contact Us</a>
        </li>
      </ul>

      <div class="mx-2">
        <button class="btn btn-danger" data-toggle="modal" data-target="#loginModal">
          Login
        </button>
        <button class="btn btn-danger" data-toggle="modal" data-target="#signupModal">
          SignUp
        </button>
      </div>
    </div>
  </nav>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Login to AK</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email address <span class="required">*</span></label>
              <input type="email" class="form-control" id="loginEmail" aria-describedby="emailHelp" required />
              <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password <span class="required">*</span></label>
              <input type="password" class="form-control" id="loginPassword" required />
              <span toggle="#loginPassword" class="fa fa-fw fa-eye field-icon toggle-password"></span>

            </div>
            <!-- <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="rememberMeCheck">
              <label class="form-check-label" for="rememberMeCheck">Remember me</label>
            </div> -->

            <button type="submit" class="btn btn-primary" id="loginButton">Login</button>
          </form>
          <a href="forgotPassword.html">Forgot Password?</a>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign Up Modal -->
  <div class="modal fade" id="signupModal" tabindex="-1" role="dialog" aria-labelledby="signupModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">
            Get an AK Account
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="signupForm">
            <div class="form-group">
              <label for="inputName">Full Name</label>
              <input type="text" class="form-control" id="inputName" name="name" placeholder="Enter your name"
                pattern=".{4,30}">
              <small class="form-text text-danger d-none">Name should be between 4 to 30 characters.</small>
            </div>
            <div class="form-group">
              <label for="inputMobile">Mobile Number</label>
              <input type="number" class="form-control" id="inputMobile" name="mobileNumber"
                placeholder="Enter your mobile no" pattern="\d{10}">
              <small class="form-text text-danger d-none">Enter a valid 10-digit mobile number.</small>
            </div>
            <div class="form-group">
              <label for="inputEmail">Email address</label>
              <input type="email" class="form-control" id="inputEmail" name="email" placeholder="Enter your email"
                aria-describedby="emailHelp">
              <small class="form-text text-danger d-none">Invalid email address.</small>
            </div>
            <div class="form-group">
              <label for="inputPassword">Password</label>
              <input type="password" class="form-control" id="inputPassword" name="password"
                pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{8,}" placeholder="Enter your password">
              <span toggle="#inputPassword" class="fa fa-fw fa-eye field-icon toggle-password"></span>

              <small class="form-text text-danger d-none">Password should contain at least 8 characters, with an
                uppercase, a lowercase, a number, and a special character.</small>
            </div>
            <div class="form-group">
              <label for="inputConfirmPassword">Confirm Password</label>
              <input type="password" class="form-control" id="inputConfirmPassword" placeholder="Re-Enter Password"
                disabled>
              <span toggle="#inputConfirmPassword" class="fa fa-fw fa-eye field-icon toggle-password"></span>

              <small class="form-text text-danger d-none">Passwords do not match.</small>
            </div>

            <button type="submit" class="btn btn-primary">Create Account</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- carousel -->
  <div id="carouselExampleCaptions" class="carousel slide carousel-fade" data-ride="carousel">
    <ol class="carousel-indicators">
      <li data-target="#carouselExampleCaptions" data-slide-to="0" class="active"></li>
      <li data-target="#carouselExampleCaptions" data-slide-to="1"></li>
      <li data-target="#carouselExampleCaptions" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="images/1.jpg" class="d-block w-100" alt="..." />
        <div class="carousel-caption d-none d-md-block">
          <h2>Welcome to AK</h2>
          <p>Technology News, Development and Trends</p>
          <button class="btn btn-danger">Technology</button>
          <button class="btn btn-primary">Web Development</button>
          <button class="btn btn-success">Tech Fun</button>
        </div>
      </div>
      <div class="carousel-item">
        <img src="images/2.jpg" class="d-block w-100" alt="..." />
        <div class="carousel-caption d-none d-md-block">
          <h2>The Best Coding Blog</h2>
          <p>Technology News, Development and Trends</p>
          <button class="btn btn-danger">Technology</button>
          <button class="btn btn-primary">Web Development</button>
          <button class="btn btn-success">Tech Fun</button>
        </div>
      </div>
      <div class="carousel-item">
        <img src="images/3.jpg" class="d-block w-100" alt="..." />
        <div class="carousel-caption d-none d-md-block">
          <h2>Award winning Blog</h2>
          <p>Technology News, Development and Trends</p>
          <button class="btn btn-danger">Technology</button>
          <button class="btn btn-primary">Web Development</button>
          <button class="btn btn-success">Tech Fun</button>
        </div>
      </div>
    </div>
    <a class="carousel-control-prev" href="#carouselExampleCaptions" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleCaptions" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>

  <!-- footer -->
  <footer class="container p-2">
    <p class="float-right">
      © 2023-2024 AK, India <a href="#">Privacy</a> ·
      <a href="#">Terms</a>
    </p>
  </footer>

  <script src="https://code.jquery.co m/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

  <script>
    $(document).ready(function () {

      // This code should be outside the submit event.
      document.addEventListener('DOMContentLoaded', function () {
        setupConfirmationChecks()
      });
      let hasAttemptedSubmission = false;

      // Validation functions
      updateLoginButtonState();

      $('#inputName').on('input', function () {
        let name = $(this).val();
        if (name.length < 4 || name.length > 30) {
          $(this).siblings('small').removeClass('d-none');
        } else {
          $(this).siblings('small').addClass('d-none');
        }
      });

      $('#inputMobile').on('input', function () {
        let mobile = $(this).val();
        if (mobile.length != 10) {
          $(this).siblings('small').removeClass('d-none');
        } else {
          $(this).siblings('small').addClass('d-none');
        }
      });

      $('#inputEmail').on('input', function () {
        let email = $(this).val();
        let regex = /^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/;
        if (!regex.test(email)) {
          $(this).siblings('small').removeClass('d-none');
        } else {
          $(this).siblings('small').addClass('d-none');
        }
      });

      $('#inputPassword').on('input', function () {
        let password = $(this).val();
        let pattern = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{8,}/;

        if (pattern.test(password)) {
          $('#inputConfirmPassword').prop('disabled', false);
          $(this).siblings('small').addClass('d-none');
          checkPasswordsMatch();
        } else {
          $('#inputConfirmPassword').prop('disabled', true);
          $(this).siblings('small').removeClass('d-none');
        }
      });

      $('#inputConfirmPassword').on('input', function () {
        checkPasswordsMatch();
      });

      $(".toggle-password").click(function () {
        $(this).toggleClass("fa-eye fa-eye-slash");
        var input = $($(this).attr("toggle"));
        if (input.attr("type") == "password") {
          input.attr("type", "text");
        } else {
          input.attr("type", "password");
        }
      });

      // Update the login button state whenever an input changes
      $("#loginEmail, #loginPassword").on('input', updateLoginButtonState);

      $('#signupForm').on('input change', function () {
        if (hasAttemptedSubmission) {
          toggleSubmitButton();
        }
      });

      $('#signupForm').submit(function (e) {
        e.preventDefault();

        // Disable the submit button at the start of validation
        $('button[type="submit"]').prop('disabled', true);

        hasAttemptedSubmission = true;
        checkValidation();
        toggleSubmitButton();
        let errors = $(this).find('small:not(.d-none)');
        if (errors.length === 0) {
          let formData = {
            name: $('#inputName').val(),
            mobileNumber: $('#inputMobile').val(),
            email: $('#inputEmail').val(),
            password: $('#inputPassword').val(),

          };

          $.ajax({
            type: "POST",
            url: "http://localhost:8080/signup",
            // data: formData,
            contentType: 'application/json',
            data: JSON.stringify(formData),

            success: function (response) {
              // Ask the user if they want to login now
              // let userResponse = confirm("Signup Successful! Do you want to login now?");

              let userResponse = confirm(
                "Registration Successful! Please check your email for confirmation."
              );


              // Clear all input fields in the signup form
              $('#signupForm input').val('');

              if (userResponse) { // If the user clicks "OK
                $('#signupModal').modal('hide');
              }
            },
            error: function (jqXHR, textStatus, errorThrown) {
              if (jqXHR.status === 0) {  // If the status code is 0, it usually indicates that the server is not responding
                alert("Server not responding. Please try again later.");
              } else {
                alert("Signup failed. Please try again.");
              }
            }
          });
        } else {
          console.log("Please correct the errors before submitting.");
        }
      });

      $('#loginForm').submit(function (e) {
        e.preventDefault();
        e.stopPropagation();
        debugger;
        // Get values from the form
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        // Make the AJAX call
        fetch('http://localhost:8080/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            switch (data.status) {
              case "email_not_found":
                alert("Email not found!");
                break;
              case "invalid_credentials":
                alert("Invalid login credentials.");
                break;
              case "Logged in successfully.":
                sessionStorage.setItem('userEmail', email);
                sessionStorage.setItem('loggedIn', 'true');
                window.location.href = "./dashboard/dashboard.html";
                break;
              case "Please check your email to confirm your registration before logging in.":
                if (!setupConfirmationChecks()) {
                  alert(
                    "Please check your email to confirm your registration before logging in."
                  );
                  $('#loginModal').modal('hide');

                }
                break;
              default:
                alert("login fails");
            }
          })
          .catch(error => {
            console.log('There was a problem with the fetch operation:', error.message);
            alert("Server not responding. Please try again later.");
          });
      });

      function setupConfirmationChecks() {
        let token = getUrlParameter("token");
        let email = getUrlParameter("email");
        if (token && email) {
          emailConfirmation(token, email);
          return true;
        }
        return false;
      }
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        let regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        let results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }
      function emailConfirmation(token, email) {
        $.ajax({
          url: "http://localhost:8080/confirm",
          method: "GET",
          data: { token: token, email: email },
          success: function (response) {
            switch (response.status) {
              case "Success":
                sessionStorage.setItem('userEmail', email);
                sessionStorage.setItem('loggedIn', 'true');
                window.location.href = "./dashboard/dashboard.html";
                break;

              default:
                alert(response.status);
                break;
            }
          },
          error: function (jqXHR, textStatus, errorThrown) {
            alert("Error confirming email: " + jqXHR.responseJSON.status);
          }
        });
      }
      function checkValidation() {
        $('#inputName').trigger('input');
        $('#inputMobile').trigger('input');
        $('#inputEmail').trigger('input');
        $('#inputPassword').trigger('input');
        $('#inputConfirmPassword').trigger('input');
      }
      function toggleSubmitButton() {
        let errors = $('#signupForm').find('small:not(.d-none)');
        if (errors.length === 0) {
          $('button[type="submit"]').prop('disabled', false);
        } else {
          $('button[type="submit"]').prop('disabled', true);
        }
      }
      function updateLoginButtonState() {
        const emailValue = $("#loginEmail").val();
        const passwordValue = $("#loginPassword").val();

        // If either input is empty, disable the login button, otherwise enable it
        if (emailValue === "" || passwordValue === "") {
          $("#loginButton").prop("disabled", true);
        } else {
          $("#loginButton").prop("disabled", false);
        }
      }
      function checkPasswordsMatch() {
        let password = $('#inputPassword').val();
        let confirmPassword = $('#inputConfirmPassword').val();
        if (password !== confirmPassword && confirmPassword.length > 0) {
          $('#inputConfirmPassword').siblings('small').text("Passwords do not match.").removeClass('d-none');
          return false;
        } else {
          $('#inputConfirmPassword').siblings('small').addClass('d-none');
          return true;
        }
      }
    });
  </script>

</body>

</html>